<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Novo Ve√≠culo ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:1.4rem; gap:8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }
    .btn-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }

    .form-card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:18px;
      box-shadow:0 8px 18px rgba(180,107,255,.15);
      max-width:820px;
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
      margin-top:10px;
    }
    .field label{
      font-size:.9rem;
      opacity:.9;
      display:block;
      margin-bottom:4px;
    }
    .field input,
    .field select,
    .field textarea{
      width:100%;
      padding:.7rem .9rem;
      border-radius:12px;
      border:none;
      outline:none;
      background:rgba(255,255,255,.08);
      color:#fff;
      box-shadow:0 0 10px rgba(180,107,255,.15);
      font-size:.95rem;
    }
    .field textarea{ min-height:90px; resize:vertical; }

    .photo-block{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:10px;
      margin-top:14px;
    }
    .preview-thumb{
      width:110px;
      height:110px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2rem;
      box-shadow:0 0 12px rgba(180,107,255,.35);
      overflow:hidden;
    }
    .preview-thumb img{
      width:100%; height:100%; object-fit:cover;
    }
    .muted{ opacity:.8; font-size:.85rem; }

    .form-actions{
      margin-top:18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .aura-toast{
      position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
    }
    .aura-toast.success{ border-color:rgba(140,255,199,.35); }
    .aura-toast.error{ border-color:rgba(255,124,107,.35); }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è‚Äç‚ôÄÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="ver.html" class="navlink active"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../pesquisa/pesquisa.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
      <li><a href="../casos/arquivados.html" class="navlink"><span class="icon">üóÉÔ∏è</span><span class="label">Casos Arquivados</span></a></li>
    </ul>
    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Novo Ve√≠culo</h1>
        <div class="actions">
          <button class="btn btn-soft" onclick="window.location.href='ver.html'">‚¨Ö Voltar</button>
        </div>
      </div>

      <div class="form-card">
        <form id="vehForm">
          <div class="form-grid">
            <div class="field">
              <label>Modelo</label>
              <input type="text" id="modelo" required placeholder="Ex: Rx7 Blindado" />
            </div>
            <div class="field">
              <label>Placa</label>
              <input type="text" id="placa" required placeholder="Ex: SOLANOS1" />
            </div>
            <div class="field">
              <label>Tipo</label>
              <input type="text" id="tipo" placeholder="Ex: Carro, Moto..." />
            </div>
            <div class="field">
              <label>Cor</label>
              <input type="text" id="cor" placeholder="Ex: Preto, Branco P√©rola..." />
            </div>
            <div class="field">
              <label>Dono (opcional)</label>
              <select id="donoSelect">
                <option value="">Sem dono / n√£o atribu√≠do</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:14px;">
            <label>Descri√ß√£o</label>
            <textarea id="descricao" placeholder="Notas sobre o ve√≠culo, modifica√ß√µes, observa√ß√µes, etc."></textarea>
          </div>

          <div class="photo-block">
            <label class="muted">Foto / Ficheiro associado</label>
            <div id="preview" class="preview-thumb">
              <img src="../Aurinha.png" alt="preview" />
            </div>
            <label class="btn btn-soft">
              üìé Anexar imagem/ficheiro
              <input type="file" id="fileInput" accept="image/*,application/pdf" hidden>
            </label>
            <div class="muted" id="fileInfo">Nenhum ficheiro selecionado.</div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-soft" onclick="window.location.href='ver.html'">Cancelar</button>
            <button type="submit" class="btn" id="saveBtn">üíæ Guardar Ve√≠culo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "../firebaseConfig.js";
    import { logAction } from "../utils/logger.js";


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("vehForm");
    const saveBtn = document.getElementById("saveBtn");
    const preview = document.getElementById("preview");
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const donoSelect = document.getElementById("donoSelect");

    let selectedFile = null;

    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),260); }, 1900);
    }

    // Carregar donos a partir de users + people
    async function loadOwners(){
      try{
        const [usersSnap, peopleSnap] = await Promise.all([
          getDocs(collection(db, "users")),
          getDocs(collection(db, "people"))
        ]);

        const all = [
          ...usersSnap.docs.map(d => ({ id: d.id, src:"user",  ...d.data() })),
          ...peopleSnap.docs.map(d => ({ id: d.id, src:"people", ...d.data() }))
        ];

        donoSelect.innerHTML = '<option value="">Sem dono / n√£o atribu√≠do</option>';

        const getNome = (p) =>
          p.name || p.displayName || p.alias || p.code || p.username || p.nome || `ID: ${p.id}`;

        all
          .sort((a,b)=> getNome(a).toLowerCase().localeCompare(getNome(b).toLowerCase()))
          .forEach(p=>{
            const nome = getNome(p);
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = nome;
            opt.dataset.nome = nome;
            donoSelect.appendChild(opt);
          });
      }catch(e){
        console.error(e);
        donoSelect.innerHTML = '<option value="">Erro ao carregar donos</option>';
        toast("Erro ao carregar donos (users + people).","error");
      }
    }

    loadOwners();

    // Preview ficheiro
    fileInput.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      selectedFile = file || null;

      if(!file){
        preview.innerHTML = '<img src="../Aurinha.png" alt="preview" />';
        fileInfo.textContent = "Nenhum ficheiro selecionado.";
        return;
      }

      fileInfo.textContent = file.name + " (" + Math.round(file.size/1024) + " KB)";

      if(file.type.startsWith("image/")){
        const reader = new FileReader();
        reader.onload = ev=>{
          preview.innerHTML = `<img src="${ev.target.result}" alt="preview" />`;
        };
        reader.readAsDataURL(file);
      }else{
        preview.innerHTML = "üìÑ";
      }
    });

    async function uploadSelectedFile(){
      if(!selectedFile) return { photoURL:null, fileName:null, fileType:null };
      const path = `veiculos/${Date.now()}_${selectedFile.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, selectedFile);
      const url = await getDownloadURL(storageRef);
      return {
        photoURL:url,
        fileName:selectedFile.name,
        fileType:selectedFile.type || null
      };
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const modelo    = document.getElementById("modelo").value.trim();
      const placa     = document.getElementById("placa").value.trim();
      const tipo      = document.getElementById("tipo").value.trim();
      const cor       = document.getElementById("cor").value.trim();
      const descricao = document.getElementById("descricao").value.trim();

      if(!modelo || !placa){
        toast("Modelo e Placa s√£o obrigat√≥rios.","error");
        return;
      }

      const donoId = donoSelect.value || null;
      let donoNome = null;
      if (donoId){
        const opt = donoSelect.options[donoSelect.selectedIndex];
        donoNome = opt.dataset.nome || opt.textContent;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = "A guardar...";

      try{
        const fileData = await uploadSelectedFile();

        await addDoc(collection(db,"veiculos"), {
          modelo,
          placa,
          tipo,
          cor,
          descricao,
          donoId,
          donoNome,
          photoURL: fileData.photoURL || null,
          fileName: fileData.fileName || null,
          fileType: fileData.fileType || null,
          estado: "ativo",
          createdAt: serverTimestamp()
        });
        await logAction("criou", "caso", title.value.trim());

        toast("Ve√≠culo criado com sucesso!");
        setTimeout(()=> window.location.href="ver.html", 700);
      }catch(e){
        console.error(e);
        toast("Erro ao criar ve√≠culo: " + e.message, "error");
        saveBtn.disabled = false;
        saveBtn.textContent = "üíæ Guardar Ve√≠culo";
      }
    });
  </script>

  <!-- LOGOUT + PERMISS√ïES -->
  <script>
    (function(){
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
          window.location.href = "../select.html";
        });
      }

      const isAdmin = localStorage.getItem("isAdmin")==="true";
      const role = (localStorage.getItem("userRole")||"").toLowerCase();
      const canEdit = isAdmin || role==="investigador";

      if(!canEdit){
        window.location.href = "ver.html";
      }
    })();
  </script>
</body>
</html>
