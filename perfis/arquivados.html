<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfis Arquivados ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:1.4rem;
    }
    .topbar h1 { margin:0; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; border-radius: 10px; color: #fff; font-weight: 600;
      padding: 8px 14px; cursor: pointer; transition: .2s;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(180,107,255,.35); }
    .grid {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
      gap: 16px;
    }
    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding: 1rem; text-align:center;
      box-shadow: 0 10px 22px rgba(180,107,255,.15);
    }
    .card img {
      width: 84px; height: 84px; border-radius: 50%; object-fit: cover;
      box-shadow: 0 0 12px rgba(180,107,255,.35);
    }
    .card h3 { margin: .6rem 0 .2rem; }
    .card p { margin: .2rem 0; opacity: .9; }
    .buttons { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:.6rem; }
    .btn-soft { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }

    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index: 1100; animation: fadeIn .15s ease; }
    .aura-modal{ width:min(520px,95vw); background: rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35); transform: translateY(6px); animation: popIn .18s ease forwards; }
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p { margin:.25rem 0 .8rem; opacity:.9; }
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end; }
    .aura-modal .aura-btn{ background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600; }
    .aura-modal .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border: none; box-shadow: 0 8px 18px rgba(159,77,255,.35); }
    .aura-modal .aura-btn.danger{ background: linear-gradient(135deg,#ff4d6d,#ff7c6b); border: none; box-shadow: 0 8px 18px rgba(255,124,107,.35); }

    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes popIn { to{ transform: translateY(0) } }

    .aura-toast{
      position: fixed; right: 16px; bottom: 16px; z-index: 1200;
      display:flex; gap:10px; align-items:center;
      background: rgba(20,0,40,.95);
      border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff;
      box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation: fadeIn .15s ease;
    }
    .aura-toast.success{ border-color: rgba(140,255,199,.35); }
    .aura-toast.error{ border-color: rgba(255,124,107,.35); }
    .aura-toast .icon{ font-size:1.2rem; }

    .only-editor {}
    .only-admin {}
  </style>
</head>

<body>
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
      <li><a href="../casos/arquivados.html" class="navlink"><span class="icon">üóÉÔ∏è</span><span class="label">Casos Arquivados</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Perfis Arquivados</h1>
        <div class="actions">
          <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div id="profilesGrid" class="grid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, deleteDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../firebaseConfig.js";
    import { logAction } from "../utils/logger.js";


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const grid = document.getElementById("profilesGrid");
    document.getElementById("backBtn").onclick = () => window.location.href = "ver.html";

    function showConfirm({ title="Confirmar", message="", confirmText="Confirmar", cancelText="Cancelar", variant="primary" }){
      return new Promise((resolve)=>{
        const wrap = document.createElement("div");
        wrap.className = "aura-modal-wrap";
        const modal = document.createElement("div");
        modal.className = "aura-modal";
        modal.innerHTML = `
          <h3>${title}</h3>
          <p>${message}</p>
          <div class="row">
            <button class="aura-btn">${cancelText}</button>
            <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${confirmText}</button>
          </div>
        `;
        wrap.appendChild(modal);
        document.body.appendChild(wrap);

        const [btnCancel, btnOk] = modal.querySelectorAll("button");
        const close = (val)=>{ wrap.remove(); resolve(val); };
        btnCancel.onclick = ()=> close(false);
        btnOk.onclick     = ()=> close(true);
        wrap.addEventListener("click", (e)=>{ if(e.target===wrap) close(false); });
        window.addEventListener("keydown", function esc(e){ if(e.key==="Escape"){ close(false); window.removeEventListener("keydown", esc);} });
      });
    }

    function toast(msg, type="success"){
      const t = document.createElement("div");
      t.className = `aura-toast ${type}`;
      t.innerHTML = `<span class="icon">${type==="success"?"‚úÖ":type==="error"?"‚ö†Ô∏è":"üíú"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(), 200); }, 1600);
    }

    async function addLog(action, itemType, itemName){
      try{
        await addDoc(collection(db, "logs"), {
          action, itemType, itemName: itemName || "",
          user: localStorage.getItem("selectedAgent") || "Desconhecido",
          timestamp: serverTimestamp()
        });
        await logAction("criou", "caso", title.value.trim());
      }catch(e){ console.warn("log fail", e); }
    }

    function tagTxt(p){
      if (p.isAdmin) return "üëë Admin";
      if ((p.role || "").toLowerCase() === "investigador") return "üïµÔ∏è Investigador";
      return "‚ú® Comum";
    }

    async function loadArchived(){
      const snap = await getDocs(collection(db,"users_archived"));
      const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      render(list);
    }

    function render(list){
      grid.innerHTML = "";
      if(!list.length){
        grid.innerHTML = "<p style='opacity:.8;'>Nenhum perfil arquivado.</p>";
        return;
      }

      list.forEach(p=>{
        const card = document.createElement("div");
        card.className = "card";

        const archivedAt =
          p.archivedAt?.seconds ? new Date(p.archivedAt.seconds*1000) :
          (p.archivedAt?.toDate ? p.archivedAt.toDate() : null);

        const cargoVal = p.cargo || "-";

        card.innerHTML = `
          <img src="${p.photoURL || '../Aurinha.png'}" alt="avatar">
          <h3>${p.name || 'Sem nome'}</h3>
          <p><b>Divis√£o:</b> ${p.division || '-'}</p>
          <p><b>Cargo:</b> ${cargoVal}</p>
          <p><b>Tag:</b> ${tagTxt(p)}</p>
          <p><b>Arquivado em:</b> ${archivedAt ? archivedAt.toLocaleDateString() : '-'}</p>

          <div class="buttons">
            <button class="btn only-editor restoreBtn">‚ôªÔ∏è Restaurar</button>
            <button class="btn btn-danger only-admin deleteBtn">üóë Eliminar</button>
          </div>
        `;

        card.querySelector(".restoreBtn")?.addEventListener("click", async ()=>{
          const ok = await showConfirm({
            title: "Restaurar perfil",
            message: `Tens a certeza que queres restaurar <b>${p.name || p.id}</b>?`,
            confirmText: "Restaurar",
            variant: "primary"
          });
          if(!ok) return;

          try{
            // ‚úÖ remove meta de arquivo / id do doc arquivado
            const { id, archivedAt, ...data } = p;
            await addDoc(collection(db,"users"), data);
            await deleteDoc(doc(db,"users_archived", p.id));
            await addLog("restaurou","perfil", p.name);
            card.remove();
            toast("Perfil restaurado!","success");
          }catch(e){ console.error(e); toast("Erro ao restaurar.","error"); }
          await logAction("criou", "caso", title.value.trim());
          await logAction("apagou", "caso", title.value.trim());
        });

        card.querySelector(".deleteBtn")?.addEventListener("click", async ()=>{
          const ok = await showConfirm({
            title: "Eliminar definitivamente",
            message: `Esta a√ß√£o n√£o pode ser desfeita. Eliminar <b>${p.name || p.id}</b>?`,
            confirmText: "Eliminar",
            variant: "danger"
          });
          if(!ok) return;

          try{
            await deleteDoc(doc(db,"users_archived", p.id));
            await addLog("eliminou","perfil arquivado", p.name);
            card.remove();
            toast("Perfil eliminado!","success");
          }catch(e){ console.error(e); toast("Erro ao eliminar.","error"); }
          await logAction("apagou", "caso", title.value.trim());
        });

        grid.appendChild(card);
      });
    }

    loadArchived();
  </script>

  <script>
(function() {
  const agent = localStorage.getItem("selectedAgent") || "Desconhecido";
  const el = document.getElementById("agentNameDisplay");
  if (el) el.textContent = `Agente: ${agent}`;

  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
      window.location.href = "../select.html";
    });
  }

  const isAdmin = localStorage.getItem("isAdmin") === "true";
  const role = (localStorage.getItem("userRole") || "").toLowerCase();
  const canEdit = role === "investigador" || isAdmin;

  if (!isAdmin) document.querySelectorAll(".only-admin").forEach(el => el.remove());

  document.querySelectorAll(".only-editor").forEach(el => {
    el.style.display = canEdit ? "" : "none";
  });
})();
</script>
</body>
</html>
