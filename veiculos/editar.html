<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Ve√≠culo ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container{padding:2rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.4rem;gap:8px;flex-wrap:wrap}

    .btn{
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;border-radius:12px;color:#fff;font-weight:700;
      padding:.7rem 1.3rem;cursor:pointer;
      box-shadow:0 10px 24px rgba(180,107,255,.35);
      transition:.25s
    }
    .btn:hover{transform:translateY(-2px)}
    .btn-soft{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}

    .form-card{
      max-width:860px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:1.4rem 1.6rem;
      box-shadow:0 20px 40px rgba(180,107,255,.18)
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px
    }

    .field label{
      display:block;
      margin-bottom:4px;
      font-size:.85rem;
      opacity:.9
    }

    .field input,.field textarea{
      width:100%;
      padding:.75rem .9rem;
      border-radius:12px;
      border:none;
      outline:none;
      background:rgba(255,255,255,.08);
      color:#fff
    }

    textarea{resize:vertical;min-height:90px}

    .photo-block{margin-top:1.2rem;display:flex;flex-direction:column;gap:10px}
    .preview{
      width:120px;height:120px;border-radius:14px;
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden
    }
    .preview img{width:100%;height:100%;object-fit:cover}

    .form-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:1.4rem}

    .autocomplete-list{
      position:absolute;top:100%;left:0;right:0;
      background:rgba(30,0,60,.98);
      border-radius:12px;
      margin-top:4px;
      max-height:180px;
      overflow-y:auto;
      display:none;
      z-index:9999
    }
    .autocomplete-item{
      padding:.55rem .7rem;
      cursor:pointer;
      font-size:.85rem
    }
    .autocomplete-item:hover{
      background:rgba(180,107,255,.22)
    }

    /* üëª ghost */
    .ghost{
      position:fixed;
      inset:0;
      background:rgba(20,0,40,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:99999
    }
    .ghost img{
      width:140px;
      animation:float 2s ease-in-out infinite
    }
    @keyframes float{
      0%{transform:translateY(0)}
      50%{transform:translateY(-14px)}
      100%{transform:translateY(0)}
    }
  </style>
</head>

<body>

<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <ul>
    <li><a href="../dashboard.html" class="navlink">üè† Dashboard</a></li>
    <li><a href="ver.html" class="navlink active">üèéÔ∏è Ve√≠culos</a></li>
  </ul>
  <button id="logoutBtn">Sair</button>
</div>

<div class="main-content">
  <div class="page-container">

    <div class="topbar">
      <h1>‚úèÔ∏è Editar Ve√≠culo</h1>
      <button class="btn btn-soft" onclick="location.href='ver.html'">‚Üê Voltar</button>
    </div>

    <form id="vehForm" class="form-card">

      <div class="form-grid">

        <div class="field">
          <label>Modelo</label>
          <input id="modelo" required>
        </div>

        <div class="field">
          <label>Placa</label>
          <input id="placa" maxlength="8" required>
        </div>

        <div class="field">
          <label>Tipo</label>
          <input id="tipo">
        </div>

        <div class="field">
          <label>Cor</label>
          <input id="cor">
        </div>

        <div class="field" style="position:relative">
          <label>Dono (opcional)</label>
          <input id="donoInput">
          <div id="donoAuto" class="autocomplete-list"></div>
        </div>

      </div>

      <div class="field" style="margin-top:1rem">
        <label>Descri√ß√£o</label>
        <textarea id="descricao"></textarea>
      </div>

      <div class="photo-block">
        <label>Imagem / Ficheiro</label>
        <div id="preview" class="preview">
          <img src="../Aurinha.png">
        </div>
        <label class="btn btn-soft">
          üìé Substituir ficheiro
          <input type="file" id="fileInput" hidden>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-soft" onclick="location.href='ver.html'">Cancelar</button>
        <button class="btn">üíæ Guardar Altera√ß√µes</button>
      </div>

    </form>

  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
import { firebaseConfig } from "../firebaseConfig.js";
import { logAction } from "../utils/logger.js";

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* permiss√µes */
const role=(localStorage.getItem("userRole")||"").toLowerCase();
const isAdmin=localStorage.getItem("isAdmin")==="true";
if(!(isAdmin||role==="investigador")) location.href="ver.html";

/* id */
const id=new URLSearchParams(location.search).get("id");
if(!id) location.href="ver.html";

/* placa */
placa.addEventListener("input",()=>{
  placa.value=placa.value.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);
});

/* autocomplete */
let people=[],donoId=null,donoNome=null;
const snap=await getDocs(collection(db,"people"));
people=snap.docs.map(d=>({id:d.id,...d.data()}));

donoInput.oninput=()=>{
  const q=donoInput.value.toLowerCase();
  donoAuto.innerHTML="";
  if(!q){donoAuto.style.display="none";return}
  people.filter(p=>(p.name||"").toLowerCase().includes(q)).slice(0,8).forEach(p=>{
    const d=document.createElement("div");
    d.className="autocomplete-item";
    d.textContent=p.name;
    d.onclick=()=>{
      donoId=p.id;
      donoNome=p.name;
      donoInput.value=p.name;
      donoAuto.style.display="none";
    };
    donoAuto.appendChild(d);
  });
  donoAuto.style.display="block";
};

/* load */
const snapVeh=await getDoc(doc(db,"veiculos",id));
if(!snapVeh.exists()) location.href="ver.html";
const v=snapVeh.data();

modelo.value=v.modelo||"";
placa.value=v.placa||"";
tipo.value=v.tipo||"";
cor.value=v.cor||"";
descricao.value=v.descricao||"";
donoId=v.donoId||null;
donoNome=v.donoNome||null;
donoInput.value=donoNome||"";

if(v.photoURL){
  preview.innerHTML=v.fileType?.startsWith("image/")
    ? `<img src="${v.photoURL}">`
    : "üìÑ";
}

/* file */
let file=null;
fileInput.onchange=e=>{
  file=e.target.files[0];
  if(file && file.type.startsWith("image/")){
    preview.innerHTML=`<img src="${URL.createObjectURL(file)}">`;
  }
};

/* ghost */
function ghost(){
  const g=document.createElement("div");
  g.className="ghost";
  g.innerHTML=`<img src="../fantasma_aura_sem_fundo.png">`;
  document.body.appendChild(g);
  return g;
}

/* submit */
vehForm.onsubmit=async e=>{
  e.preventDefault();
  const g=ghost();

  let photoURL=v.photoURL||null,fileName=v.fileName||null,fileType=v.fileType||null;
  if(file){
    const r=ref(storage,`veiculos/${Date.now()}_${file.name}`);
    await uploadBytes(r,file);
    photoURL=await getDownloadURL(r);
    fileName=file.name;
    fileType=file.type;
  }

  await updateDoc(doc(db,"veiculos",id),{
    modelo:modelo.value.trim(),
    placa:placa.value,
    tipo:tipo.value.trim(),
    cor:cor.value.trim(),
    descricao:descricao.value.trim(),
    donoId,
    donoNome,
    photoURL,
    fileName,
    fileType
  });

  await logAction("editou","ve√≠culo",modelo.value.trim());
  location.href="ver.html";
};
</script>

</body>
</html>
