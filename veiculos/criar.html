<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Novo Ve√≠culo ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container{padding:2rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.4rem;gap:8px;flex-wrap:wrap}

    .btn{
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;border-radius:12px;color:#fff;font-weight:700;
      padding:.7rem 1.3rem;cursor:pointer;
      box-shadow:0 10px 24px rgba(180,107,255,.35);
      transition:.25s
    }
    .btn:hover{transform:translateY(-2px)}
    .btn-soft{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}

    .form-card{
      max-width:860px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:1.4rem 1.6rem;
      box-shadow:0 20px 40px rgba(180,107,255,.18)
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px
    }

    .field label{
      display:block;
      margin-bottom:4px;
      font-size:.85rem;
      opacity:.9
    }

    .field input,.field textarea{
      width:100%;
      padding:.75rem .9rem;
      border-radius:12px;
      border:none;
      outline:none;
      background:rgba(255,255,255,.08);
      color:#fff
    }

    textarea{resize:vertical;min-height:90px}

    .photo-block{margin-top:1.2rem;display:flex;flex-direction:column;gap:10px}
    .preview{
      width:120px;height:120px;border-radius:14px;
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden
    }
    .preview img{width:100%;height:100%;object-fit:cover}

    .form-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:1.4rem}

    /* autocomplete */
    .autocomplete-list{
      position:absolute;top:100%;left:0;right:0;
      background:rgba(30,0,60,.98);
      border-radius:12px;
      margin-top:4px;
      max-height:180px;
      overflow-y:auto;
      display:none;
      z-index:9999
    }
    .autocomplete-item{
      padding:.55rem .7rem;
      cursor:pointer;
      font-size:.85rem
    }
    .autocomplete-item:hover{
      background:rgba(180,107,255,.22)
    }
  </style>
</head>

<body>

<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <ul>
    <li><a href="../dashboard.html" class="navlink">üè† Dashboard</a></li>
    <li><a href="ver.html" class="navlink active">üèéÔ∏è Ve√≠culos</a></li>
  </ul>
  <button id="logoutBtn">Sair</button>
</div>

<div class="main-content">
  <div class="page-container">

    <div class="topbar">
      <h1>‚ûï Novo Ve√≠culo</h1>
      <button class="btn btn-soft" onclick="location.href='ver.html'">‚Üê Voltar</button>
    </div>

    <form id="vehForm" class="form-card">

      <div class="form-grid">

        <div class="field">
          <label>Modelo</label>
          <input id="modelo" required>
        </div>

        <div class="field">
          <label>Placa</label>
          <input id="placa" maxlength="8" required placeholder="ABC1234">
        </div>

        <div class="field">
          <label>Tipo</label>
          <input id="tipo">
        </div>

        <div class="field">
          <label>Cor</label>
          <input id="cor">
        </div>

        <div class="field" style="position:relative">
          <label>Dono (opcional)</label>
          <input id="donoInput" placeholder="Pesquisar pessoa...">
          <div id="donoAuto" class="autocomplete-list"></div>
        </div>

      </div>

      <div class="field" style="margin-top:1rem">
        <label>Descri√ß√£o</label>
        <textarea id="descricao"></textarea>
      </div>

      <div class="photo-block">
        <label>Imagem / Ficheiro</label>
        <div id="preview" class="preview">
          <img src="../Aurinha.png">
        </div>
        <label class="btn btn-soft">
          üìé Anexar
          <input type="file" id="fileInput" hidden>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-soft" onclick="location.href='ver.html'">Cancelar</button>
        <button class="btn">üíæ Guardar Ve√≠culo</button>
      </div>

    </form>

  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
import { firebaseConfig } from "../firebaseConfig.js";
import { logAction } from "../utils/logger.js";

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* permiss√µes */
const role = (localStorage.getItem("userRole")||"").toLowerCase();
const isAdmin = localStorage.getItem("isAdmin")==="true";
if(!(isAdmin || role==="investigador")) location.href="ver.html";

/* placa */
const placaEl = document.getElementById("placa");
placaEl.addEventListener("input",()=>{
  placaEl.value = placaEl.value.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);
});

/* autocomplete dono */
let people=[];
let donoId=null,donoNome=null;
const donoInput=document.getElementById("donoInput");
const donoAuto=document.getElementById("donoAuto");

const snap=await getDocs(collection(db,"people"));
people=snap.docs.map(d=>({id:d.id,...d.data()}));

donoInput.oninput=()=>{
  const q=donoInput.value.toLowerCase();
  donoAuto.innerHTML="";
  if(!q){donoAuto.style.display="none";return}
  people.filter(p=>(p.name||"").toLowerCase().includes(q)).slice(0,8).forEach(p=>{
    const d=document.createElement("div");
    d.className="autocomplete-item";
    d.textContent=p.name;
    d.onclick=()=>{
      donoId=p.id;
      donoNome=p.name;
      donoInput.value=p.name;
      donoAuto.style.display="none";
    };
    donoAuto.appendChild(d);
  });
  donoAuto.style.display="block";
};

/* ficheiro */
let file=null;
fileInput.onchange=e=>{
  file=e.target.files[0];
  if(file && file.type.startsWith("image/")){
    preview.innerHTML=`<img src="${URL.createObjectURL(file)}">`;
  }
};

/* submit */
vehForm.onsubmit=async e=>{
  e.preventDefault();

  let photoURL=null,fileName=null,fileType=null;
  if(file){
    const r=ref(storage,`veiculos/${Date.now()}_${file.name}`);
    await uploadBytes(r,file);
    photoURL=await getDownloadURL(r);
    fileName=file.name;
    fileType=file.type;
  }

  await addDoc(collection(db,"veiculos"),{
    modelo:modelo.value.trim(),
    placa:placa.value,
    tipo:tipo.value.trim(),
    cor:cor.value.trim(),
    descricao:descricao.value.trim(),
    donoId,
    donoNome,
    photoURL,
    fileName,
    fileType,
    estado:"ativo",
    createdAt:serverTimestamp()
  });

  await logAction("criou","ve√≠culo",modelo.value.trim());
  location.href="ver.html";
};
</script>

</body>
</html>
