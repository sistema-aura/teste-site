<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Per√≠metros de A√ß√£o ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:1.4rem; gap:8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s;
      box-shadow:0 0 10px rgba(180,107,255,.25);
      font-size:.9rem;
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }
    .btn-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }
    .btn-sm{ padding:5px 9px; font-size:.8rem; box-shadow:none; }
    .btn-sm:hover{ box-shadow:0 0 10px rgba(180,107,255,.25); transform:translateY(-1px); }

    .searchbar { margin:.5rem 0 1.2rem; display:flex; gap:8px; }
    .searchbar input {
      flex:1; padding:.8rem 1rem; border-radius:12px; border:none;
      background:rgba(255,255,255,.08); color:#fff; outline:none;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }

    .muted{opacity:.8; font-size:.9rem;}

    /* BLOCO DE CATEGORIA ("PASTA") */
    .cat-block{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      margin-bottom:16px;
      box-shadow:0 8px 18px rgba(180,107,255,.12);
      overflow:hidden;
    }
    .cat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      background:linear-gradient(90deg,rgba(155,77,255,.35),rgba(12,0,40,.95));
      cursor:pointer;
    }
    .cat-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:.95rem;
    }
    .cat-title span.folder{
      font-size:1.1rem;
    }
    .cat-count{
      font-size:.78rem;
      opacity:.85;
    }
    .cat-toggle{
      border:none;
      background:rgba(0,0,0,.25);
      color:#fff;
      border-radius:999px;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.85rem;
      transform:rotate(0deg);
      transition:.18s;
    }
    .cat-block.collapsed .cat-toggle{
      transform:rotate(-90deg);
    }

    .cat-body{
      padding:10px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .cat-block.collapsed .cat-body{
      display:none;
    }

    /* CARD DA A√á√ÉO (RET√ÇNGULO) */
    .act-card{
      background:rgba(10,0,35,.9);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      padding:12px 12px 10px;
      box-shadow:0 8px 18px rgba(180,107,255,.15);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .act-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .act-header h3{
      margin:0;
      font-size:1rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 9px;
      border-radius:999px;
      font-size:.75rem;
      background:rgba(255,255,255,.06);
    }
    .pill.tipo{ opacity:.9; }
    .pill.estado-ativo{ background:rgba(140,255,199,.12); color:#8cffc7; }
    .pill.estado-inativo{ background:rgba(255,124,107,.12); color:#ff9b8a; }

    .act-desc{
      font-size:.9rem;
      color:#eee;
      white-space:pre-line; /* mant√©m quebras de linha como no Discord */
    }

    .act-image{
      margin-top:4px;
      border-radius:12px;
      overflow:hidden;
      max-height:260px;
      border:1px solid rgba(255,255,255,.07);
    }
    .act-image img{
      width:100%;
      display:block;
      object-fit:cover;
    }

    .act-footer{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }

    /* Toast */
    .aura-toast{
      position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
    }
    .aura-toast.success{ border-color:rgba(140,255,199,.35); }
    .aura-toast.error{ border-color:rgba(255,124,107,.35); }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Modal simples para Ver */
    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1400; animation:fadeIn .15s ease;}
    .aura-modal{ width:min(720px,95vw); background:rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35);}
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p{ margin:.25rem 0 .5rem; opacity:.9;}
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:.8rem;}
    .aura-btn{ background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600;}
    .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border:none;}
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>

      <!-- AQUI: removi o active do Regras CDA -->
      <li><a href="../regras/ver.html" class="navlink"><span class="icon">üìö</span><span class="label">Regras CDA</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Per√≠metros de A√ß√£o</h1>
        <div class="actions">
          <button id="newBtn" class="btn only-editor">‚ûï Nova A√ß√£o</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBar" placeholder="Pesquisar por local, tipo ou descri√ß√£o da a√ß√£o..." />
      </div>

      <div id="groupsWrap"></div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../firebaseConfig.js";
    import { logAction } from "../utils/logger.js";


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const groupsWrap = document.getElementById("groupsWrap");
    const searchInput = document.getElementById("searchBar");

    // Permiss√µes
    const isAdmin = localStorage.getItem("isAdmin")==="true";
    const roleStr = (localStorage.getItem("userRole")||"").toLowerCase();
    const canEdit = isAdmin || roleStr==="investigador";

    // Navega√ß√£o
    document.getElementById("newBtn").onclick = ()=> window.location.href="criar.html";

    // Toast
    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),260); }, 1900);
    }

    // Modal confirmar
    function confirmModal({title="Confirmar", message="Tens a certeza?", okText="Confirmar", variant="primary"}){
      return new Promise(resolve=>{
        const wrap=document.createElement("div");
        wrap.className="aura-modal-wrap";
        wrap.innerHTML=`
          <div class="aura-modal">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="row">
              <button class="aura-btn">Cancelar</button>
              <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${okText}</button>
            </div>
          </div>`;
        document.body.appendChild(wrap);
        const [cancelBtn, okBtn] = wrap.querySelectorAll("button");
        const close = (v)=>{ wrap.remove(); resolve(v); };
        cancelBtn.onclick = ()=> close(false);
        okBtn.onclick     = ()=> close(true);
        wrap.addEventListener("click",(e)=>{ if(e.target===wrap) close(false); });
      });
    }

    let allActs = [];

    async function loadActs(){
      try{
        const snap = await getDocs(collection(db,"perimetros")); // cole√ß√£o sugerida
        allActs = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // opcional: filtrar s√≥ ativos se tiveres campo estado
        allActs = allActs.filter(a => (a.estado || "ativo") !== "inativo");

        // ordenar por categoria e depois t√≠tulo
        allActs.sort((a,b)=>{
          const ca = (a.categoria || "Outros").toLowerCase();
          const cb = (b.categoria || "Outros").toLowerCase();
          if(ca !== cb) return ca.localeCompare(cb);
          const ta = (a.titulo || "").toLowerCase();
          const tb = (b.titulo || "").toLowerCase();
          return ta.localeCompare(tb);
        });

        renderGroups(allActs);
      }catch(e){
        console.error(e);
        toast("Erro ao carregar per√≠metros: " + e.message, "error");
      }
    }

    function groupByCategoria(list){
      const map = new Map();
      list.forEach(a=>{
        const cat = a.categoria || "Outros";
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(a);
      });
      return Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
    }

    function makeActCard(a){
      const el = document.createElement("div");
      el.className = "act-card";

      const estado = (a.estado || "ativo").toLowerCase();
      const isAtivo = estado === "ativo";

      const tipo = a.tipo || "";
      const titulo = a.titulo || a.nome || "Sem t√≠tulo";

      const desc = a.descricao || "";

      const imgHtml = a.photoURL
        ? `<img src="${a.photoURL}" alt="per√≠metro">`
        : `<img src="../Aurinha.png" alt="per√≠metro">`;

      el.innerHTML = `
        <div class="act-header">
          <h3>${titulo}</h3>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            ${tipo ? `<span class="pill tipo">${tipo}</span>` : ""}
            <span class="pill ${isAtivo ? "estado-ativo" : "estado-inativo"}">
              ‚óè ${isAtivo ? "Ativo" : "Inativo"}
            </span>
          </div>
        </div>
        <div class="act-desc">${desc}</div>
        <div class="act-image">${imgHtml}</div>
        <div class="act-footer">
          <button class="btn btn-soft btn-sm viewBtn">Ver</button>
          ${canEdit ? `
            <button class="btn btn-soft btn-sm editBtn">Editar</button>
            <button class="btn btn-danger btn-sm delBtn">Eliminar</button>
          ` : ""}
        </div>
      `;

      // Ver: modal simples com texto + imagem
      el.querySelector(".viewBtn").onclick = ()=>{
        const wrap = document.createElement("div");
        wrap.className="aura-modal-wrap";

        const descHtml = (a.descricao || "Sem descri√ß√£o.").replace(/\n/g,"<br>");

        const imgModal = a.photoURL
          ? `<div style="margin:8px 0 10px;"><img src="${a.photoURL}" alt="per√≠metro" style="width:100%;border-radius:12px;box-shadow:0 0 12px rgba(180,107,255,.35);"></div>`
          : "";

        wrap.innerHTML = `
          <div class="aura-modal">
            <h3>${titulo}</h3>
            <p><b>Categoria:</b> ${a.categoria || "Outros"}</p>
            ${tipo ? `<p><b>Tipo:</b> ${tipo}</p>` : ""}
            <p><b>Estado:</b> ${isAtivo ? "Ativo" : "Inativo"}</p>
            <p><b>Descri√ß√£o / Briefing:</b><br>${descHtml}</p>
            ${imgModal}
            <div class="row">
              <button class="aura-btn primary">Fechar</button>
            </div>
          </div>`;
        wrap.querySelector("button").onclick = ()=> wrap.remove();
        wrap.addEventListener("click",(e)=>{ if(e.target===wrap) wrap.remove(); });
        document.body.appendChild(wrap);
      };

      // Editar
      el.querySelector(".editBtn")?.addEventListener("click", ()=>{
        window.location.href = `editar.html?id=${a.id}`;
      });

      // Eliminar
      el.querySelector(".delBtn")?.addEventListener("click", async ()=>{
        const ok = await confirmModal({
          title:"Eliminar a√ß√£o",
          message:`Esta a√ß√£o √© permanente. Eliminar <b>${titulo}</b>?`,
          okText:"Eliminar",
          variant:"danger"
        });
        if(!ok) return;
        try{
          await deleteDoc(doc(db,"perimetros", a.id));
          el.remove();
          toast("A√ß√£o eliminada!");
        }catch(e){
          console.error(e);
          toast("Erro ao eliminar: " + e.message, "error");
        }
      });

      return el;
    }

    function renderGroups(list){
      groupsWrap.innerHTML = "";
      if(!list.length){
        groupsWrap.innerHTML = "<p class='muted'>Nenhuma a√ß√£o registada.</p>";
        return;
      }

      const grouped = groupByCategoria(list);

      grouped.forEach(([cat, items])=>{
        const catEl = document.createElement("div");
        catEl.className = "cat-block";

        const header = document.createElement("div");
        header.className = "cat-header";
        header.innerHTML = `
          <div class="cat-title">
            <span class="folder">üìÅ</span>
            <span>${cat}</span>
            <span class="cat-count">${items.length} a√ß√£o(√µes)</span>
          </div>
          <button class="cat-toggle">‚ñæ</button>
        `;

        const body = document.createElement("div");
        body.className = "cat-body";

        items.forEach(a => body.appendChild(makeActCard(a)));

        header.addEventListener("click", ()=>{
          catEl.classList.toggle("collapsed");
        });

        catEl.appendChild(header);
        catEl.appendChild(body);
        groupsWrap.appendChild(catEl);
      });
    }

    // Pesquisa
    searchInput.addEventListener("input", (e)=>{
      const t = (e.target.value || "").toLowerCase().trim();
      if(!t){
        renderGroups(allActs);
        return;
      }
      const filtered = allActs.filter(a=>{
        const titulo = (a.titulo || a.nome || "").toLowerCase();
        const cat    = (a.categoria || "").toLowerCase();
        const tipo   = (a.tipo || "").toLowerCase();
        const desc   = (a.descricao || "").toLowerCase();
        return (
          titulo.includes(t) ||
          cat.includes(t) ||
          tipo.includes(t) ||
          desc.includes(t)
        );
      });
      renderGroups(filtered);
    });

    loadActs();
  </script>

  <!-- LOGOUT + PERMISS√ïES VISUAIS -->
  <script>
    (function(){
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
          window.location.href = "../select.html";
        });
      }

      const isAdmin = localStorage.getItem("isAdmin")==="true";
      const role = (localStorage.getItem("userRole")||"").toLowerCase();
      const canEdit = isAdmin || role==="investigador";

      if (!canEdit) {
        document.querySelectorAll(".only-editor").forEach(el => el.style.display = "none");
      }
    })();
  </script>
</body>
</html>
