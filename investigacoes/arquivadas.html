<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Investiga√ß√µes Arquivadas ‚Äî Sistema AURA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="../Aurinha.png">
  <link rel="stylesheet" href="../style.css">

  <style>
    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:1rem;
    }

    .btn-soft{
      background:rgba(180,107,255,.18);
      border:1px solid rgba(180,107,255,.35);
      border-radius:14px;
      padding:.6rem 1.2rem;
      color:#fff;
      cursor:pointer;
      font-weight:800;
      text-decoration:none;
    }
    .btn-danger{
      background:linear-gradient(135deg,#ff4d6d,#ff7c6b);
      border:none;
      border-radius:14px;
      padding:.6rem 1.2rem;
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .row{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:1.2rem 1.3rem;
      box-shadow:0 18px 40px rgba(180,107,255,.18);
      display:flex;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .left{flex:1;min-width:260px}
    .title{font-size:1.1rem;font-weight:900;margin:0}
    .sub{opacity:.9;font-size:.9rem;margin:.25rem 0 0}

    .mid{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      min-width:200px;
      align-items:center;
    }

    .pill{
      padding:.4rem .7rem;
      border-radius:999px;
      background:rgba(168,85,247,.18);
      border:1px solid rgba(168,85,247,.30);
      font-size:.8rem;
      font-weight:800;
    }

    .status{
      padding:.4rem .7rem;
      border-radius:999px;
      background:rgba(255,180,80,.18);
      border:1px solid rgba(255,180,80,.35);
      font-size:.8rem;
      font-weight:900;
      color:#ffd9a6;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:300px;
      align-items:center;
    }

    /* üëª ghost */
    .ghost-overlay{
      position:fixed;
      inset:0;
      background:rgba(20,0,40,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      backdrop-filter:blur(6px);
    }
    .ghost-overlay img{
      width:160px;
      animation:ghostFloat 1.6s ease-in-out infinite,
               ghostSpin 2.8s linear infinite;
    }
    @keyframes ghostFloat{50%{transform:translateY(-12px)}}
    @keyframes ghostSpin{to{rotate:360deg}}
  </style>
</head>

<body>

<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>


    <button id="logoutBtn">Sair</button>
  </div>

<div class="main-content">
  <div class="page-container">

    <div class="top-row">
      <div style="display:flex;align-items:center;gap:10px">
        <button class="btn-soft" onclick="history.back()">‚Üê</button>
        <h1>üóÉ Investiga√ß√µes Arquivadas</h1>
      </div>
      <a href="ver.html" class="btn-soft">üïµÔ∏è Ver Ativas</a>
    </div>

    <div id="list" class="list"></div>

  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, onSnapshot,
  updateDoc, deleteDoc, doc, query, where
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { firebaseConfig } from "../firebaseConfig.js";
import { logAction } from "../utils/logger.js";


const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);
const listEl = document.getElementById("list");

/* üëª ghost */
function showGhost(){
  const g=document.createElement("div");
  g.className="ghost-overlay";
  g.innerHTML=`<img src="../fantasma_aura_sem_fundo.png">`;
  document.body.appendChild(g);
  return g;
}

/* render */
function render(list){
  listEl.innerHTML="";
  if(!list.length){
    listEl.innerHTML=`
      <div class="row">
        <p style="opacity:.75">Nenhuma investiga√ß√£o arquivada.</p>
      </div>`;
    return;
  }

  list.forEach(i=>{
    const row=document.createElement("div");
    row.className="row";

    row.innerHTML=`
      <div class="left">
        <p class="title">${i.titulo||"Sem t√≠tulo"}</p>
        <p class="sub"><b>Respons√°vel:</b> ${i.responsavel||"-"}</p>
      </div>

      <div class="mid">
        <span class="status">üì¶ ARQUIVADA</span>
        <span class="pill">üë• ${(i.envolvidos||[]).length}</span>
        <span class="pill">üöó ${(i.veiculos||[]).length}</span>
        <span class="pill">‚öîÔ∏è ${(i.faccoes||[]).length}</span>
        <span class="pill">üì∏ ${(i.fotos||[]).length}</span>
      </div>

      <div class="actions">
        <button class="btn-soft reopenBtn">üóÉ Reabrir</button>
        <button class="btn-danger deleteBtn">üóë Eliminar</button>
      </div>
    `;

    /* reabrir */
    row.querySelector(".reopenBtn").onclick = async ()=>{
      const g = showGhost();
      await updateDoc(doc(db,"investigacoes",i.id),{
        estado:"ativo"
      });
      // üëâ volta para as ativas
      location.href = "ver.html";
     await logAction("editou", "caso", title.value.trim());
    };

    /* eliminar */
    row.querySelector(".deleteBtn").onclick = async ()=>{
      if(!confirm("Eliminar definitivamente?")) return;
      const g = showGhost();
      await deleteDoc(doc(db,"investigacoes",i.id));
      g.remove();
      await logAction("apagou", "caso", title.value.trim());
    };

    listEl.appendChild(row);
  });
}

/* realtime (arquivadas) */
const q = query(
  collection(db,"investigacoes"),
  where("estado","==","arquivado")
);

onSnapshot(q,snap=>{
  const data = snap.docs.map(d=>({id:d.id,...d.data()}));
  render(data);
});
</script>

<script>
(function(){
  agentNameDisplay.textContent =
    `Agente: ${localStorage.getItem("selectedAgent")||"Desconhecido"}`;

  logoutBtn.onclick=()=>{
    ["username","selectedAgent","userRole","userCode","isAdmin"]
      .forEach(k=>localStorage.removeItem(k));
    location.href="../select.html";
  };
})();
</script>

</body>
</html>
