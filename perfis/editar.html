<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Perfil ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; max-width: 1100px; margin: 0 auto; }
    .topbar {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:1.2rem;
    }
    .topbar h1 { margin:0; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; border-radius: 10px; color: #fff; font-weight: 600;
      padding: 8px 14px; cursor: pointer; transition: .2s;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(180,107,255,.35); }
    .btn-soft { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }

    .form-grid {
      display:grid; grid-template-columns: repeat(12, 1fr); gap:16px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding: 14px; box-shadow:0 10px 22px rgba(180,107,255,.15);
    }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-weight:600; opacity:.95; }
    .field input, .field select, .field textarea {
      width: 100%; padding:.75rem .9rem; border-radius:12px; border:none; outline:none;
      background: rgba(255,255,255,.08); color:#fff;
      box-shadow: 0 0 10px rgba(180,107,255,.18);
    }
    .field input[type="file"] {
      padding: .55rem .7rem; background: rgba(255,255,255,.06);
    }
    .field textarea { min-height: 120px; resize: vertical; }

    .preview { display:flex; align-items:center; gap:12px; }
    .preview img {
      width: 84px; height: 84px; border-radius: 10px; object-fit: cover;
      box-shadow: 0 0 12px rgba(180,107,255,.35);
      border: 1px solid rgba(255,255,255,.08);
    }

    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-8 { grid-column: span 8; }
    .col-12{ grid-column: span 12; }

    .muted { opacity:.8; }

    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1100; animation: fadeIn .15s ease; }
    .aura-modal{ width:min(540px,95vw); background: rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35); transform: translateY(6px); animation: popIn .18s ease forwards; }
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p{ margin:.25rem 0 .8rem; opacity:.9; }
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end; }
    .aura-modal .aura-btn{ background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600; }
    .aura-modal .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border:none; box-shadow: 0 8px 18px rgba(159,77,255,.35); }
    .aura-modal .aura-btn.danger{ background: linear-gradient(135deg,#ff4d6d,#ff7c6b); border:none; box-shadow: 0 8px 18px rgba(255,124,107,.35); }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} } @keyframes popIn { to{ transform: translateY(0) } }
    .aura-toast{ position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center; background: rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08); padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35); animation: fadeIn .15s ease; }
    .aura-toast.success{ border-color: rgba(140,255,199,.35); }
    .aura-toast.error{ border-color: rgba(255,124,107,.35); }
    .aura-toast .icon{ font-size:1.2rem; }

    .only-editor {}
    .only-admin {}
  </style>
</head>

<body>
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
      <li><a href="../casos/arquivados.html" class="navlink"><span class="icon">üóÉÔ∏è</span><span class="label">Casos Arquivados</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Editar Perfil</h1>
        <div class="actions">
          <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
          <button id="archiveBtn" class="btn only-editor">üì¶ Arquivar</button>
          <button id="deleteBtn" class="btn btn-danger only-admin">üóë Eliminar</button>
        </div>
      </div>

      <form id="editForm" class="form-grid">
        <div class="field col-6">
          <label for="name">Nome</label>
          <input id="name" placeholder="Nome completo" />
        </div>

        <div class="field col-6">
          <label for="division">Divis√£o</label>
          <input id="division" placeholder="Investiga√ß√£o / Grupo A√©reo / Corrida / Estrat√©gia..." />
        </div>

        <!-- ‚úÖ NOVO: CARGO LIVRE -->
        <div class="field col-4">
          <label for="cargo">Cargo (livre)</label>
          <input id="cargo" placeholder="Ex: 01" />
        </div>

        <div class="field col-4">
          <label for="joinDate">Entrada</label>
          <input id="joinDate" type="date" />
        </div>

        <div class="field col-4">
          <label for="alias">Alias/Nick</label>
          <input id="alias" placeholder="Opcional" />
        </div>

        <div class="field col-12">
          <label>Foto (ficheiro do PC)</label>
          <div class="preview">
            <img id="photoPreview" src="../Aurinha.png" alt="preview">
            <input id="photoFile" type="file" accept="image/*" />
          </div>
          <small class="muted">Opcional: se escolheres um ficheiro, fazemos upload no Storage e atualizamos a foto automaticamente.</small>
        </div>

        <div class="field col-12">
          <label for="photoURL">Foto (URL)</label>
          <input id="photoURL" placeholder="https://..." />
        </div>

        <div class="field col-12">
          <label for="description">Descri√ß√£o</label>
          <textarea id="description" placeholder="Notas, conquistas, observa√ß√µes..."></textarea>
        </div>

        <div class="field col-6 only-admin">
          <label for="isAdmin">Administrador</label>
          <select id="isAdmin">
            <option value="false">N√£o</option>
            <option value="true">Sim</option>
          </select>
        </div>

        <div class="field col-6">
          <label for="roleView">Cargo/Role (tag Investigador)</label>
          <input id="roleView" disabled class="muted" />
          <small class="muted">Para alterar Investigador usa o bot√£o no ecr√£ de listagem.</small>
        </div>

        <div class="col-12" style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" id="saveBtn" class="btn only-editor">üíæ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, addDoc, deleteDoc, collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "../firebaseConfig.js";
    import { logAction } from "../utils/logger.js";


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const q = new URLSearchParams(location.search);
    const id = q.get("id");
    if (!id) location.href = "ver.html";

    const name = document.getElementById("name");
    const division = document.getElementById("division");
    const cargo = document.getElementById("cargo"); // ‚úÖ
    const joinDate = document.getElementById("joinDate");
    const alias = document.getElementById("alias");
    const photoURL = document.getElementById("photoURL");
    const photoFile = document.getElementById("photoFile");
    const photoPreview = document.getElementById("photoPreview");
    const description = document.getElementById("description");
    const roleView = document.getElementById("roleView");
    const isAdminSel = document.getElementById("isAdmin");

    const backBtn = document.getElementById("backBtn");
    const saveBtn = document.getElementById("saveBtn");
    const archiveBtn = document.getElementById("archiveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    backBtn.onclick = () => history.back();

    function showConfirm({ title="Confirmar", message="", confirmText="Confirmar", cancelText="Cancelar", variant="primary" }){
      return new Promise((resolve)=>{
        const wrap = document.createElement("div");
        wrap.className = "aura-modal-wrap";
        const modal = document.createElement("div");
        modal.className = "aura-modal";
        modal.innerHTML = `
          <h3>${title}</h3>
          <p>${message}</p>
          <div class="row">
            <button class="aura-btn">${cancelText}</button>
            <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${confirmText}</button>
          </div>
        `;
        wrap.appendChild(modal);
        document.body.appendChild(wrap);

        const [btnCancel, btnOk] = modal.querySelectorAll("button");
        const close = (val)=>{ wrap.remove(); resolve(val); };
        btnCancel.onclick = ()=> close(false);
        btnOk.onclick     = ()=> close(true);
        wrap.addEventListener("click", (e)=>{ if(e.target===wrap) close(false); });
        window.addEventListener("keydown", function esc(e){ if(e.key==="Escape"){ close(false); window.removeEventListener("keydown", esc);} });
      });
    }

    function toast(msg, type="success"){
      const t = document.createElement("div");
      t.className = `aura-toast ${type}`;
      t.innerHTML = `<span class="icon">${type==="success"?"‚úÖ":type==="error"?"‚ö†Ô∏è":"üíú"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(), 220); }, 1800);
    }

    async function addLog(action, itemType, itemName){
      try{
        await addDoc(collection(db, "logs"), {
          action, itemType, itemName: itemName || "",
          user: localStorage.getItem("selectedAgent") || "Desconhecido",
          timestamp: serverTimestamp()
        });
        await logAction("criou", "caso", title.value.trim());
      }catch(e){ console.warn("log fail", e); }
    }

    photoFile.addEventListener("change", ()=>{
      const f = photoFile.files?.[0];
      if (!f) return;
      photoPreview.src = URL.createObjectURL(f);
    });

    async function maybeUploadPhoto(userId){
      const f = photoFile.files?.[0];
      if (!f) return null;
      const safeName = (f.name || "photo").replace(/[^\w.\-]+/g,"_");
      const storageRef = ref(storage, `users/${userId}/${Date.now()}_${safeName}`);
      await uploadBytes(storageRef, f);
      return await getDownloadURL(storageRef);
    }

    let original = null;
    (async ()=>{
      try{
        const snap = await getDoc(doc(db, "users", id));
        if (!snap.exists()) { toast("Perfil n√£o encontrado.","error"); return; }
        original = { id, ...snap.data() };

        name.value = original.name || "";
        division.value = original.division || "";
        cargo.value = original.cargo || ""; // ‚úÖ
        joinDate.value = original.joinDate ? (String(original.joinDate).length===10 ? original.joinDate : "") : "";
        alias.value = original.alias || original.nick || "";
        photoURL.value = original.photoURL || "";
        photoPreview.src = original.photoURL || "../Aurinha.png";
        description.value = original.description || original.observacoes || "";
        roleView.value = original.role || "";
        isAdminSel.value = (original.isAdmin === true) ? "true" : "false";
      }catch(e){ console.error(e); toast("Erro ao carregar perfil.","error"); }
    })();

    saveBtn.addEventListener("click", async ()=>{
      const ok = await showConfirm({
        title: "Guardar altera√ß√µes",
        message: `Confirmas as altera√ß√µes em <b>${name.value || original?.name || id}</b>?`,
        confirmText: "Guardar",
        variant: "primary"
      });
      if(!ok) return;

      try{
        const uploadedURL = await maybeUploadPhoto(id);
        if (uploadedURL) photoURL.value = uploadedURL;

        const payload = {
          name: name.value.trim(),
          division: division.value.trim(),
          cargo: cargo.value.trim(), // ‚úÖ
          joinDate: joinDate.value || "",
          alias: alias.value.trim(),
          photoURL: photoURL.value.trim(),
          description: description.value.trim(),
        };

        const isAdmin = (localStorage.getItem("isAdmin") === "true" || localStorage.getItem("isAdmin") === true);
        if (isAdmin) payload.isAdmin = (isAdminSel.value === "true");

        await updateDoc(doc(db, "users", id), payload);
        await addLog("editou", "perfil", name.value || original?.name || id);
        toast("Altera√ß√µes guardadas!","success");
      }catch(e){ console.error(e); toast("Erro ao guardar.","error"); }
           await logAction("editou", "caso", title.value.trim());
    });

    archiveBtn.addEventListener("click", async ()=>{
      const ok = await showConfirm({
        title: "Arquivar perfil",
        message: `Queres arquivar <b>${name.value || original?.name || id}</b>? Podes restaurar mais tarde.`,
        confirmText: "Arquivar",
        variant: "primary"
      });
      if(!ok) return;

      try{
        const uploadedURL = await maybeUploadPhoto(id);
        const payload = {
          ...original,
          name: name.value.trim() || original?.name || "",
          division: division.value.trim() || original?.division || "",
          cargo: cargo.value.trim() || original?.cargo || "", // ‚úÖ
          joinDate: joinDate.value || original?.joinDate || "",
          alias: alias.value.trim() || original?.alias || original?.nick || "",
          photoURL: uploadedURL ? uploadedURL : (photoURL.value.trim() || original?.photoURL || ""),
          description: description.value.trim() || original?.description || "",
          archivedAt: serverTimestamp()
        };

        await addDoc(collection(db,"users_archived"), payload);
        await deleteDoc(doc(db,"users", id));
        await addLog("arquivou","perfil", payload.name || id);
        toast("Perfil arquivado!","success");
        setTimeout(()=> location.href = "ver.html", 600);
      }catch(e){ console.error(e); toast("Erro ao arquivar.","error"); }
    });
    await logAction("criou", "caso", title.value.trim());
    await logAction("apagou", "caso", title.value.trim());

    deleteBtn.addEventListener("click", async ()=>{
      const ok = await showConfirm({
        title: "Eliminar perfil",
        message: `Esta a√ß√£o √© permanente. Eliminar <b>${name.value || original?.name || id}</b>?`,
        confirmText: "Eliminar",
        variant: "danger"
      });
      if(!ok) return;

      try{
        await deleteDoc(doc(db,"users", id));
        await addLog("eliminou","perfil", name.value || original?.name || id);
        toast("Perfil eliminado!","success");
        setTimeout(()=> location.href = "ver.html", 600);
      }catch(e){ console.error(e); toast("Erro ao eliminar.","error"); }
        await logAction("apagou", "perfil", nameEl.value.trim());

    });
  </script>

  <script>
(function() {
  const agent = localStorage.getItem("selectedAgent") || "Desconhecido";
  const el = document.getElementById("agentNameDisplay");
  if (el) el.textContent = `Agente: ${agent}`;

  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
      window.location.href = "../select.html";
    });
  }

  const isAdmin = localStorage.getItem("isAdmin") === "true";
  const role = (localStorage.getItem("userRole") || "").toLowerCase();
  const canEdit = role === "investigador" || isAdmin;

  if (!isAdmin) document.querySelectorAll(".only-admin").forEach(el => el.remove());

  document.querySelectorAll(".only-editor").forEach(el => {
    el.style.display = canEdit ? "" : "none";
  });

  if (!canEdit) {
    document.querySelectorAll("input, textarea, select, button").forEach(el => {
      if (el.id === "logoutBtn") return;
      if (el.closest(".only-admin")) return;
      if (el.closest(".only-editor")) { el.disabled = true; return; }
    });
  }
})();
</script>
</body>
</html>
