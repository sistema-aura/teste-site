<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ve√≠culos ‚Äî Sistema AURA</title>

<link rel="icon" href="../Aurinha.png">
<link rel="stylesheet" href="../style.css">

<style>
a{text-decoration:none!important}

/* TOP */
.top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:1rem;
  flex-wrap:wrap;
}
.top-left{display:flex;align-items:center;gap:10px}
.top-actions{display:flex;gap:10px;flex-wrap:wrap}

/* BOT√ïES */
.btn-soft-aura{
  background:rgba(180,107,255,.18);
  border:1px solid rgba(180,107,255,.35);
  border-radius:14px;
  padding:.6rem 1.2rem;
  font-weight:800;
  color:#fff;
  cursor:pointer;
  transition:.25s;
}
.btn-soft-aura:hover{background:rgba(180,107,255,.28);transform:translateY(-2px)}

.btn-main-aura{
  background:linear-gradient(135deg,#a855f7,#7c3aed);
  border:none;
  border-radius:14px;
  padding:.65rem 1.4rem;
  font-weight:900;
  color:#fff;
  cursor:pointer;
  box-shadow:0 12px 30px rgba(168,85,247,.35);
  transition:.25s;
}
.btn-main-aura:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(168,85,247,.45)}

.btn-danger-aura{
  background:linear-gradient(135deg,#ff4d6d,#ff7c6b);
  border:none;
  border-radius:14px;
  padding:.6rem 1.2rem;
  font-weight:900;
  color:#fff;
  cursor:pointer;
  transition:.25s;
}
.btn-danger-aura:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(255,77,109,.35)}

/* SEARCH */
.search-wrapper{
  position:relative;
  margin:.3rem 0 1.2rem;
}
.search-wrapper input{
  width:100%;
  padding:.85rem 1rem .85rem 2.8rem;
  border-radius:14px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
}
.search-wrapper span{
  position:absolute;
  left:1rem;
  top:50%;
  transform:translateY(-50%);
  opacity:.75;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}

/* CARD */
.card{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:1.2rem;
  box-shadow:0 18px 40px rgba(180,107,255,.18);
  backdrop-filter:blur(12px);
  transition:.25s;
}
.card:hover{transform:translateY(-2px);box-shadow:0 24px 52px rgba(180,107,255,.26)}

.thumb{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:14px;
  margin-bottom:.6rem;
  box-shadow:0 0 18px rgba(180,107,255,.35);
}

.card h3{margin:.2rem 0;font-weight:900}
.meta{font-size:.9rem;opacity:.9;margin:.15rem 0}
.meta b{color:#fff}

.actions{
  display:flex;
  gap:10px;
  margin-top:.8rem;
  flex-wrap:wrap;
  justify-content:flex-end;
}

/* MODAL */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(20,0,40,.6);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal-box{
  background:rgba(30,0,60,.95);
  border-radius:18px;
  padding:1.4rem;
  width:min(520px,95%);
  box-shadow:0 20px 55px rgba(180,107,255,.35);
}

/* GHOST */
.ghost-global{
  position:fixed;
  inset:0;
  background:rgba(15,10,30,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
}
.ghost-global img{
  width:150px;
  animation:float 2.5s ease-in-out infinite;
}
@keyframes float{
  50%{transform:translateY(-12px)}
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <span id="agentNameDisplay" class="agent-display"></span>

  <ul>
    <li><a href="../dashboard.html" class="navlink"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
    <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
    <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
    <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
    <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
    <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
    <li><a href="../veiculos/ver.html" class="navlink active"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
    <li><a href="../regras/ver.html" class="navlink"><span class="icon">üìö</span><span class="label">Regras CDA</span></a></li>
  </ul>

  <button id="logoutBtn">Sair</button>
</div>

<!-- CONTE√öDO -->
<div class="main-content">
  <div class="page-container">

    <div class="top-row">
      <div class="top-left">
        <button class="btn-soft-aura" onclick="history.back()">‚Üê</button>
        <h1>üèéÔ∏è Ve√≠culos</h1>
      </div>
      <div class="top-actions">
        <a id="btnNovo" href="criar.html" class="btn-main-aura">‚ûï Novo Ve√≠culo</a>
      </div>
    </div>

    <div class="search-wrapper">
      <span>üîç</span>
      <input id="searchBar" placeholder="Pesquisar por modelo, placa ou dono...">
    </div>

    <div id="grid" class="grid"></div>

  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, query, where, onSnapshot, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { firebaseConfig } from "../firebaseConfig.js";
import { logAction } from "../utils/logger.js";

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);

const role = (localStorage.getItem("userRole")||"").toLowerCase();
const isAdmin = localStorage.getItem("isAdmin")==="true";
const canEdit = isAdmin || role==="investigador";

if(!canEdit) document.getElementById("btnNovo")?.remove();

const grid = document.getElementById("grid");
const search = document.getElementById("searchBar");
let all = [];

function ghost(){
  const g=document.createElement("div");
  g.className="ghost-global";
  g.innerHTML=`<img src="../fantasma_aura_sem_fundo.png">`;
  document.body.appendChild(g);
  return g;
}

function render(list){
  grid.innerHTML="";
  list.forEach(v=>{
    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <img class="thumb" src="${v.photoURL||"../Aurinha.png"}">
      <h3>${v.modelo||"Sem modelo"}</h3>
      <div class="meta"><b>Placa:</b> ${v.placa||"-"}</div>
      <div class="meta"><b>Dono:</b> ${v.donoNome||"-"}</div>
      <div class="meta"><b>Tipo:</b> ${v.tipo||"-"}</div>

      <div class="actions">
        <button class="btn-soft-aura view">üëÅ Ver</button>
        ${canEdit?`<a class="btn-soft-aura" href="editar.html?id=${v.id}">‚úèÔ∏è Editar</a>`:""}
        ${canEdit?`<button class="btn-danger-aura del">üóë</button>`:""}
      </div>
    `;

    card.querySelector(".view").onclick=()=>{
      const m=document.createElement("div");
      m.className="modal-overlay";
      m.innerHTML=`
        <div class="modal-box">
          <h3>${v.modelo}</h3>
          <p><b>Placa:</b> ${v.placa}</p>
          <p><b>Dono:</b> ${v.donoNome||"-"}</p>
          <p><b>Descri√ß√£o:</b><br>${(v.descricao||"").replaceAll("\n","<br>")}</p>
          <div style="text-align:right;margin-top:10px">
            <button class="btn-soft-aura close">Fechar</button>
          </div>
        </div>`;
      document.body.appendChild(m);
      m.querySelector(".close").onclick=()=>m.remove();
      m.onclick=e=>{if(e.target===m)m.remove();}
    };

    card.querySelector(".del")?.addEventListener("click",async()=>{
      if(!confirm("Eliminar ve√≠culo?")) return;
      const g=ghost();
      await deleteDoc(doc(db,"veiculos",v.id));
      await logAction("apagou","ve√≠culo",`${v.modelo} (${v.placa})`);
      g.remove();
    });

    grid.appendChild(card);
  });
}

search.oninput=()=>{
  const q=search.value.toLowerCase();
  render(all.filter(v=>
    (v.modelo||"").toLowerCase().includes(q) ||
    (v.placa||"").toLowerCase().includes(q) ||
    (v.donoNome||"").toLowerCase().includes(q)
  ));
};

const q=query(collection(db,"veiculos"),where("estado","==","ativo"));
onSnapshot(q,snap=>{
  all=snap.docs.map(d=>({id:d.id,...d.data()}));
  render(all);
});

document.getElementById("agentNameDisplay").innerText =
  "Agente: "+(localStorage.getItem("selectedAgent")||"-");

document.getElementById("logoutBtn").onclick=()=>{
  ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
  location.href="../select.html";
};
</script>

</body>
</html>
