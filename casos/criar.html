<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Criar Caso ‚Äî Sistema AURA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="../Aurinha.png">
  <link rel="stylesheet" href="../style.css">

  <style>
    .form-card{
      max-width:1000px;
      margin:0 auto;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:1.6rem 1.8rem;
      box-shadow:0 18px 40px rgba(180,107,255,.18);
    }

    .section{ margin-top:1.4rem; }
    .section h3{ margin:0 0 .7rem; font-size:1rem; }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
    }

    .form-group label{
      display:block;
      font-size:.85rem;
      opacity:.85;
      margin-bottom:4px;
    }

    .form-group input,
    textarea{
      width:100%;
      padding:.75rem .9rem;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      color:#fff;
      outline:none;
    }

    textarea{ resize:vertical; }

    .relation-block{
      background:rgba(180,107,255,.06);
      border:1px solid rgba(180,107,255,.18);
      border-radius:16px;
      padding:1rem 1.1rem;
      margin-top:1.2rem;
    }

    .relation-header{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      font-size:.95rem;
      margin-bottom:.6rem;
      color:#e9d5ff;
    }

    .search-wrapper{
      position:relative;
      margin-top:.2rem;
    }

    .search-wrapper input{
      width:100%;
      padding:.75rem 1rem .75rem 2.6rem;
      border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-size:.85rem;
      transition:.25s;
    }

    .search-wrapper input::placeholder{
      color:rgba(255,255,255,.5);
    }

    .search-wrapper input:focus{
      outline:none;
      border-color:#a855f7;
      box-shadow:0 0 0 2px rgba(168,85,247,.35);
      background:rgba(0,0,0,.45);
    }

    .search-wrapper .icon{
      position:absolute;
      left:.9rem;
      top:50%;
      transform:translateY(-50%);
      font-size:.9rem;
      opacity:.7;
      pointer-events:none;
    }

    .autocomplete-box{ position:relative; }

    .autocomplete-list{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:rgba(30,0,60,.98);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      margin-top:4px;
      max-height:180px;
      overflow-y:auto;
      z-index:9999;
      display:none;
    }

    .autocomplete-item{
      padding:.55rem .7rem;
      cursor:pointer;
      font-size:.8rem;
    }

    .autocomplete-item:hover{
      background:rgba(180,107,255,.22);
    }

    .chip-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:.35rem .6rem;
      border-radius:999px;
      background:rgba(168,85,247,.25);
      border:1px solid rgba(168,85,247,.35);
      font-size:.75rem;
      font-weight:700;
    }

    .chip button{
      border:none;
      background:none;
      color:#fff;
      cursor:pointer;
      font-weight:900;
    }

    .btn-save{
      background:linear-gradient(135deg,#a855f7,#7c3aed);
      border:none;
      border-radius:14px;
      padding:.75rem 1.6rem;
      font-weight:800;
      color:#fff;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(168,85,247,.35);
      transition:.25s;
    }

    .btn-save:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 40px rgba(168,85,247,.45);
    }

    .btn-save:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .actions{
      display:flex;
      justify-content:flex-end;
      margin-top:1.8rem;
    }

    .ghost-overlay{
      position:fixed;
      inset:0;
      background:rgba(20,0,40,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      backdrop-filter:blur(15px);
    }

    .ghost-overlay img{
      width:400px;
      animation:ghostFloat 1.6s ease-in-out infinite,
               ghostSpin 2.8s linear infinite;
    }

    @keyframes ghostFloat{
      0%,100%{transform:translateY(0);}
      50%{transform:translateY(-12px);}
    }

    @keyframes ghostSpin{
      from{rotate:0deg;}
      to{rotate:360deg;}
    }
  </style>
</head>

<body>

<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <span id="agentNameDisplay" class="agent-display">Agente: -</span>

  <ul>
    <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
    <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
    <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
    <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
    <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
    <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
    <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
    <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
    <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
    <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
    <li><a href="../regras/ver.html" class="navlink"><span class="icon">üìö</span><span class="label">Regras CDA</span></a></li>
  </ul>

  <button id="logoutBtn">Sair</button>
</div>

<div class="main-content">
  <div class="page-container">

    <div style="display:flex;align-items:center;gap:10px;margin-bottom:1rem">
      <button class="btn btn-soft" onclick="history.back()">‚Üê</button>
      <h1>‚ûï Criar Caso</h1>
    </div>

    <form id="createForm" class="form-card">

      <div class="section">
        <h3>üßæ Identifica√ß√£o</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>T√≠tulo</label>
            <input id="title" required>
          </div>
          <div class="form-group">
            <label>Respons√°vel</label>
            <input id="responsible">
          </div>
        </div>
      </div>

      <div class="relation-block">
        <div class="relation-header">üë• Pessoas Envolvidas</div>
        <div class="autocomplete-box search-wrapper">
          <span class="icon">üîç</span>
          <input id="peopleSearch" placeholder="Procurar pessoa...">
          <div id="peopleAuto" class="autocomplete-list"></div>
        </div>
        <div id="peopleChips" class="chip-list"></div>
      </div>

      <div class="relation-block">
        <div class="relation-header">üöó Ve√≠culos Envolvidos</div>
        <div class="autocomplete-box search-wrapper">
          <span class="icon">üîç</span>
          <input id="vehicleSearch" placeholder="Procurar ve√≠culo (placa ou modelo)...">
          <div id="vehicleAuto" class="autocomplete-list"></div>
        </div>
        <div id="vehicleChips" class="chip-list"></div>
      </div>

      <div class="relation-block">
        <div class="relation-header">‚öîÔ∏è Fac√ß√µes Envolvidas</div>
        <div class="autocomplete-box search-wrapper">
          <span class="icon">üîç</span>
          <input id="factionSearch" placeholder="Procurar fac√ß√£o...">
          <div id="factionAuto" class="autocomplete-list"></div>
        </div>
        <div id="factionChips" class="chip-list"></div>
      </div>

      <div class="section">
        <h3>üìé Descri√ß√£o</h3>
        <textarea id="description" rows="6"></textarea>
      </div>

      <div class="actions">
        <button id="saveBtn" type="submit" class="btn-save">üëª Guardar Caso</button>
      </div>

    </form>

  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { firebaseConfig } from "../firebaseConfig.js";
import { logAction } from "../utils/logger.js";

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);

const selected = { people:[], vehicles:[], factions:[] };

function setupSearch(inputId, autoId, chipsId, col, key, labelFn, chipFn){
  const input=document.getElementById(inputId);
  const auto=document.getElementById(autoId);
  const chips=document.getElementById(chipsId);
  let items=[];

  getDocs(collection(db,col)).then(s=>{
    items=s.docs.map(d=>({id:d.id,...d.data()}));
  });

  function addItem(item){
    if(selected[key].includes(item.id)) return;
    selected[key].push(item.id);

    const chip=document.createElement("span");
    chip.className="chip";
    chip.innerHTML=`${chipFn(item)} <button>√ó</button>`;
    chip.querySelector("button").onclick=()=>{
      selected[key]=selected[key].filter(i=>i!==item.id);
      chip.remove();
    };
    chips.appendChild(chip);
    auto.style.display="none";
    input.value="";
  }

  input.addEventListener("input",()=>{
    const q=input.value.toLowerCase();
    auto.innerHTML="";
    if(!q){ auto.style.display="none"; return; }

    items.filter(i=>labelFn(i).toLowerCase().includes(q))
      .slice(0,8)
      .forEach(i=>{
        const d=document.createElement("div");
        d.className="autocomplete-item";
        d.textContent=labelFn(i);
        d.onclick=()=>addItem(i);
        auto.appendChild(d);
      });

    auto.style.display=auto.children.length?"block":"none";
  });
}

setupSearch("peopleSearch","peopleAuto","peopleChips","people","people",
  p=>p.name||"Sem nome",p=>p.name||"Sem nome");

setupSearch("vehicleSearch","vehicleAuto","vehicleChips","veiculos","vehicles",
  v=>`${v.placa}${v.modelo?" ‚Äî "+v.modelo:""}`,v=>v.placa);

setupSearch("factionSearch","factionAuto","factionChips","facc","factions",
  f=>`${f.nome}${f.sigla?" ("+f.sigla+")":""}`,f=>f.nome);

function showGhost(){
  const g=document.createElement("div");
  g.className="ghost-overlay";
  g.innerHTML=`<img src="../fantasma_aura_sem_fundo.png">`;
  document.body.appendChild(g);
  return g;
}

createForm.onsubmit = async e=>{
  e.preventDefault();

  const t = title.value.trim();
  if(!t){
    alert("O t√≠tulo √© obrigat√≥rio.");
    return;
  }

  saveBtn.disabled=true;
  const ghost = showGhost();

  try{
    await addDoc(collection(db,"cases"),{
      title: t,
      responsible: responsible.value.trim(),
      people: selected.people,
      vehicles: selected.vehicles,
      factions: selected.factions,
      description: description.value.trim(),
      archived: false,
      createdAt: serverTimestamp()
    });

    await logAction("criou", "caso", t);

    setTimeout(()=>location.href="ver.html",600);
  }catch(err){
    console.error("Erro ao criar caso:", err);
    alert("Erro ao criar caso.");
    saveBtn.disabled=false;
    ghost.remove();
  }
};
</script>

<script>
(function(){
  agentNameDisplay.textContent=`Agente: ${localStorage.getItem("selectedAgent")||"Desconhecido"}`;
  logoutBtn.onclick=()=>{
    ["username","selectedAgent","userRole","userCode","isAdmin"]
      .forEach(k=>localStorage.removeItem(k));
    location.href="../select.html";
  };
})();
</script>

</body>
</html>
