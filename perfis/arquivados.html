<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfis Arquivados ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:1.4rem;
    }
    .topbar h1 { margin:0; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; border-radius: 10px; color: #fff; font-weight: 600;
      padding: 8px 14px; cursor: pointer; transition: .2s;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(180,107,255,.35); }
    .grid {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
      gap: 16px;
    }
    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding: 1rem; text-align:center;
      box-shadow: 0 10px 22px rgba(180,107,255,.15);
    }
    .card img {
      width: 84px; height: 84px; border-radius: 50%; object-fit: cover;
      box-shadow: 0 0 12px rgba(180,107,255,.35);
    }
    .card h3 { margin: .6rem 0 .2rem; }
    .card p { margin: .2rem 0; opacity: .9; }
    .buttons { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:.6rem; }
    .btn-soft { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }

    .only-editor {}
    .only-admin {}
  </style>
</head>

<body>
<div class="sidebar">
  <h2 class="logo">SISTEMA AURA</h2>
  <span id="agentNameDisplay" class="agent-display">Agente: -</span>

  <ul>
    <li><a href="../dashboard.html" class="navlink active">üè† Dashboard</a></li>
    <li><a href="../perfis/ver.html" class="navlink">üëë Perfil da Aura</a></li>
    <li><a href="../people/ver.html" class="navlink">üßç Pessoas</a></li>
    <li><a href="../casos/ver.html" class="navlink">üìÅ Casos</a></li>
  </ul>

  <button id="logoutBtn">Sair</button>
</div>

<div class="main-content">
  <div class="page-container">
    <div class="topbar">
      <h1>Perfis Arquivados</h1>
      <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
    </div>

    <div id="profilesGrid" class="grid"></div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { firebaseConfig } from "../firebaseConfig.js";

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);

const grid = document.getElementById("profilesGrid");
document.getElementById("backBtn").onclick = () => location.href = "ver.html";

async function addLog(action, itemType, itemName){
  try{
    await addDoc(collection(db,"logs"),{
      action,
      itemType,
      itemName: itemName || "",
      user: localStorage.getItem("selectedAgent") || "Desconhecido",
      timestamp: serverTimestamp()
    });
  }catch(e){ console.warn("log fail", e); }
}

function tagTxt(p){
  if(p.isAdmin) return "üëë Admin";
  if((p.role||"").toLowerCase()==="investigador") return "üïµÔ∏è Investigador";
  return "‚ú® Comum";
}

async function loadArchived(){
  const snap = await getDocs(collection(db,"users_archived"));
  const list = snap.docs.map(d=>({id:d.id,...d.data()}));
  render(list);
}

function render(list){
  grid.innerHTML="";
  if(!list.length){
    grid.innerHTML="<p style='opacity:.8;'>Nenhum perfil arquivado.</p>";
    return;
  }

  list.forEach(p=>{
    const card=document.createElement("div");
    card.className="card";

    const archivedAt=p.archivedAt?.seconds
      ? new Date(p.archivedAt.seconds*1000)
      : p.archivedAt?.toDate?.();

    card.innerHTML=`
      <img src="${p.photoURL||'../Aurinha.png'}">
      <h3>${p.name||'Sem nome'}</h3>
      <p><b>Divis√£o:</b> ${p.division||'-'}</p>
      <p><b>Cargo:</b> ${p.cargo||'-'}</p>
      <p><b>Tag:</b> ${tagTxt(p)}</p>
      <p><b>Arquivado em:</b> ${archivedAt?archivedAt.toLocaleDateString():'-'}</p>
      <div class="buttons">
        <button class="btn only-editor restoreBtn">‚ôªÔ∏è Restaurar</button>
        <button class="btn btn-danger only-admin deleteBtn">üóë Eliminar</button>
      </div>
    `;

    card.querySelector(".restoreBtn")?.addEventListener("click",async()=>{
      const {id,archivedAt,...data}=p;
      await addDoc(collection(db,"users"),data);
      await deleteDoc(doc(db,"users_archived",p.id));
      await addLog("restaurou","perfil",p.name);
      card.remove();
    });

    card.querySelector(".deleteBtn")?.addEventListener("click",async()=>{
      await deleteDoc(doc(db,"users_archived",p.id));
      await addLog("eliminou","perfil",p.name);
      card.remove();
    });

    grid.appendChild(card);
  });
}

loadArchived();
</script>

<script>
(function(){
  const agent=localStorage.getItem("selectedAgent")||"Desconhecido";
  document.getElementById("agentNameDisplay").textContent=`Agente: ${agent}`;

  document.getElementById("logoutBtn").onclick=()=>{
    ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
    location.href="../select.html";
  };

  const isAdmin=localStorage.getItem("isAdmin")==="true";
  const role=(localStorage.getItem("userRole")||"").toLowerCase();
  const canEdit=role==="investigador"||isAdmin;

  if(!isAdmin) document.querySelectorAll(".only-admin").forEach(e=>e.remove());
  document.querySelectorAll(".only-editor").forEach(e=>e.style.display=canEdit?"":"none");
})();
</script>
</body>
</html>
