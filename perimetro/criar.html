<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Novo Per√≠metro ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; max-width: 980px; margin:0 auto; }
    .topbar {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:1.4rem; gap:8px; flex-wrap:wrap;
    }

    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 10px 22px rgba(180,107,255,.15);
    }

    label {
      font-weight:600;
      opacity:.95;
      margin-bottom:6px;
      display:block;
    }

    input, textarea, select {
      width:100%;
      padding:.8rem 1rem;
      border-radius:12px;
      border:none;
      outline:none;
      background:rgba(255,255,255,.08);
      color:#fff;
      box-shadow:0 0 10px rgba(180,107,255,.18);
      margin-bottom:1rem;
      font-size:.95rem;
    }
    textarea { resize: vertical; min-height: 140px; }

    .row-2 {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
    }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }
    .btn-soft{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }

    .file-row { display:flex; align-items:center; gap:12px; margin: 8px 0 4px; flex-wrap:wrap; }
    .preview {
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.06);
      padding:10px; border-radius:12px;
      margin-top:6px;
    }
    .preview img {
      width:120px; height:120px; object-fit:cover;
      border-radius:10px;
      box-shadow:0 0 12px rgba(180,107,255,.35);
    }
    .preview .fileinfo { font-size:.95rem; opacity:.9; }

    .muted{ opacity:.8; font-size:.9rem; }

    /* Toast */
    .aura-toast{
      position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
    }
    .aura-toast.success{ border-color:rgba(140,255,199,.35); }
    .aura-toast.error{ border-color:rgba(255,124,107,.35); }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>

      <!-- AQUI: removi o active do Regras CDA -->
      <li><a href="../regras/ver.html" class="navlink"><span class="icon">üìö</span><span class="label">Regras CDA</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Novo Per√≠metro</h1>
        <div style="display:flex; gap:8px;">
          <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
          <button id="saveBtn" class="btn">üíæ Guardar</button>
        </div>
      </div>

      <form id="actForm" class="card">
        <label>T√≠tulo da a√ß√£o</label>
        <input id="titulo" placeholder="Ex: Per√≠metro do Banco Central" required />

        <div class="row-2">
          <div>
            <label>Categoria / Pasta</label>
            <input id="categoria" list="catList" placeholder="Ex: Lojinhas, Banco Central, Fleeca..." />
            <datalist id="catList">
              <option value="Lojinhas"></option>
              <option value="Banco Central"></option>
              <option value="Fleeca"></option>
              <option value="Joalheria"></option>
              <option value="Madereira"></option>
              <option value="Galinheiro"></option>
              <option value="A√ßougue"></option>
              <option value="Aeroporto"></option>
              <option value="Zancudo"></option>
              <option value="Ferro-Velho"></option>
              <option value="Ilha do Cartel"></option>
              <option value="Blackout"></option>
            </datalist>
            <p class="muted">A categoria √© o nome da ‚Äúpasta‚Äù onde esta a√ß√£o aparece.</p>
          </div>
          <div>
            <label>Tipo (opcional)</label>
            <input id="tipo" placeholder="Ex: Roubo a banco, Lojinha, Sequestro..." />
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Estado</label>
            <select id="estado">
              <option value="ativo" selected>Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
          </div>
        </div>

        <label>Descri√ß√£o / Briefing</label>
        <textarea id="descricao" placeholder="Texto que aparece por cima da imagem. Podes usar v√°rias linhas para Bandidos, Policiais, Armamento, etc."></textarea>

        <label>Anexo (imagem ou PDF)</label>
        <div class="file-row">
          <input id="fileInput" type="file" accept="image/*,.pdf" />
          <span class="muted">Recomendado: screenshot do mapa da √°rea.</span>
        </div>
        <div id="filePreview" class="preview" style="display:none;"></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, addDoc, updateDoc, doc, collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "../firebaseConfig.js";
    import { logAction } from "../utils/logger.js";


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const stg = getStorage(app);

    const tituloEl     = document.getElementById("titulo");
    const categoriaEl  = document.getElementById("categoria");
    const tipoEl       = document.getElementById("tipo");
    const estadoEl     = document.getElementById("estado");
    const descricaoEl  = document.getElementById("descricao");
    const fileInput    = document.getElementById("fileInput");
    const filePreview  = document.getElementById("filePreview");
    const btnSave      = document.getElementById("saveBtn");
    const btnBack      = document.getElementById("backBtn");

    btnBack.onclick = ()=> window.location.href="ver.html";

    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),260); }, 1900);
    }

    // preview ficheiro
    fileInput.addEventListener("change", ()=>{
      const f=fileInput.files?.[0];
      if(!f){
        filePreview.style.display="none";
        filePreview.innerHTML="";
        return;
      }
      filePreview.style.display="flex";
      if(f.type.startsWith("image/")){
        const url = URL.createObjectURL(f);
        filePreview.innerHTML = `<img src="${url}" alt="preview"><span class="fileinfo">${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB</span>`;
      } else {
        filePreview.innerHTML = `<span class="fileinfo">üìÑ ${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB</span>`;
      }
    });

    // permiss√µes
    const isAdmin = localStorage.getItem("isAdmin")==="true";
    const role = (localStorage.getItem("userRole")||"").toLowerCase();
    const canEdit = isAdmin || role==="investigador";
    if(!canEdit){
      btnSave.style.display="none";
      document.querySelectorAll("input, textarea, select").forEach(e=>e.disabled=true);
      toast("Sem permiss√£o para criar per√≠metros.","error");
    }

    btnSave.addEventListener("click", async (e)=>{
      e.preventDefault();
      if(!canEdit){
        toast("Sem permiss√£o para criar.","error");
        return;
      }

      const titulo = (tituloEl.value||"").trim();
      if(!titulo){
        toast("T√≠tulo √© obrigat√≥rio.","error");
        return;
      }

      const payload = {
        titulo,
        categoria: (categoriaEl.value||"").trim() || "Outros",
        tipo: (tipoEl.value||"").trim(),
        estado: estadoEl.value || "ativo",
        descricao: (descricaoEl.value||"").trim(),
        photoURL: null,
        fileName: null,
        fileType: null,
        createdAt: serverTimestamp()
      };

      btnSave.disabled = true;
      btnSave.textContent = "A guardar...";

      try{
        const refDoc = await addDoc(collection(db,"perimetros"), payload);

        const f = fileInput.files?.[0];
        if(f){
          const safe = f.name.replace(/[^\w.\-]+/g,"_");
          const path = `perimetros_files/${refDoc.id}/${Date.now()}_${safe}`;
          const sref = ref(stg, path);
          await uploadBytes(sref, f);
          const url = await getDownloadURL(sref);
          await updateDoc(doc(db,"perimetros", refDoc.id), {
            photoURL: url,
            fileName: f.name,
            fileType: f.type || ""
          });
          await logAction("criou", "caso", title.value.trim());
          await logAction("editou", "caso", title.value.trim());
        }

        toast("Per√≠metro criado!");
        setTimeout(()=> window.location.href="ver.html", 900);
      }catch(e){
        console.error(e);
        toast("Erro ao criar: " + e.message, "error");
        btnSave.disabled = false;
        btnSave.textContent = "üíæ Guardar";
      }
    });

    // logout
    document.getElementById("logoutBtn").onclick=()=>{
      ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
      window.location.href="../select.html";
    };
  </script>
</body>
</html>
