<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema AURA üíú ‚Äî Recriar Users (Completo)</title>

  <link rel="icon" href="Aurinha.png" />
  <style>
    body {
      background: radial-gradient(circle at top left, #3c0064, #150026);
      color: white;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 1.5rem;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      width: 680px;
      max-width: 100%;
    }
    h1 { margin: 0 0 10px 0; color:#e8d9ff; }
    p { margin: 0 0 14px 0; opacity:0.9; }
    button {
      background: linear-gradient(90deg,#b46bff,#9b4dff);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    pre {
      background: rgba(0,0,0,0.35);
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üíú Recriar Perfis AURA (com senhas aleat√≥rias)</h1>
    <p>Cria todos os perfis em <code>users</code>. Faz download autom√°tico do ficheiro <code>senhas_aura.txt</code>.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="seedBtn">Criar Perfis</button>
      <button id="clearBtn" style="background:linear-gradient(90deg,#ff6b6b,#ff4d4d)">Apagar cole√ß√£o users (USE COM CAUTELA)</button>
    </div>

    <pre id="result">Aguardando a√ß√£o...</pre>
  </div>

  <!-- Script modular (v10) -->
  <script type="module">
    import { app, db } from './firebaseConfig.js';
    import {
      collection,
      doc,
      setDoc,
      serverTimestamp,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { logAction } from "../utils/logger.js";


    const seedBtn = document.getElementById('seedBtn');
    const clearBtn = document.getElementById('clearBtn');
    const result = document.getElementById('result');

    // lista completa de perfis
    const auraProfiles = [
      { code: "A-00", name: "Duda Solano", role: "Veterano" },
      { code: "A-01", name: "Himaru Black", role: "01" },
      { code: "A-02", name: "Aisha Ferraz", role: "02" },
      { code: "A-03", name: "Atlas Solano", role: "Veterano" },
      { code: "A-04", name: "Gabriel Solano", role: "Veterano" },
      { code: "A-05", name: "Jotave", role: "Veterano" },
      { code: "A-06", name: "Lucas Ferraz", role: "Veterano" },
      { code: "A-07", name: "Danny Kalashnikov", role: "Veterano" },
      { code: "A-08", name: "Sprexi Aizen", role: "Veterano" },
      { code: "A-09", name: "Caio Ferraz", role: "Veterano" },
      { code: "A-10", name: "Ruben Silva", role: "Veterano" },
      { code: "A-11", name: "Isaque Alves", role: "Veterano" },
      { code: "A-12", name: "Isa Callas", role: "Veterano" },
      { code: "A-13", name: "John Akasi", role: "Veterano" },
      { code: "A-14", name: "Gabriel Linker", role: "Veterano" },
      { code: "A-15", name: "Nolan Akashi", role: "Soldado" },
      { code: "A-16", name: "Kau√£ Melione", role: "Soldado" },
      { code: "A-17", name: "Diego Brown", role: "Soldado" },
      { code: "A-18", name: "Orfeu Dybala", role: "Soldado" },
      { code: "A-19", name: "Baiano", role: "Membro" },
      { code: "A-20", name: "Jamaica", role: "Membro" },
      { code: "A-21", name: "Rodrigo Casarin", role: "Membro" },
      { code: "A-22", name: "Rech Marino", role: "Membro" },
      { code: "A-23", name: "Erica Madrazzo", role: "Recruta" },
      { code: "A-24", name: "Erick Mendez", role: "Recruta" },
      { code: "A-25", name: "Midnight", role: "Recruta" },
      { code: "A-26", name: "James Stewart", role: "Recruta" },
      { code: "A-27", name: "Kassandra Ferraz", role: "Recruta" },
      { code: "A-28", name: "Manuela Ferrari", role: "Recruta" },
      { code: "A-29", name: "Ayla Ferraz", role: "Recruta" },
      { code: "A-30", name: "Fabyana Ferraz", role: "Recruta" },
      { code: "A-31", name: "Margarida Novak", role: "Recruta" },
      { code: "A-32", name: "Yuri Candelaria", role: "Recruta" },
      { code: "A-33", name: "Mateus Silva", role: "Recruta" },
      { code: "A-34", name: "Luna Petrov", role: "Recruta" },
      { code: "A-35", name: "Cicero Ribeiro", role: "Recruta" }
    ];

    function randomString(len = 8) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let s = '';
      for (let i = 0; i < len; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
      return s;
    }

    async function seedUsers() {
      seedBtn.disabled = true;
      result.textContent = 'üíú A criar perfis... aguarde...';

      try {
        let created = 0;
        let lines = 'üíú Lista de senhas criadas:\n\n';

        for (const p of auraProfiles) {
          const password = 'aur4_' + randomString(8);
          let tag = "";

          if (p.code === "A-00") tag = "admin";
          if (p.code === "A-23") tag = "investigador";

          const payload = {
            code: p.code,
            name: p.name,
            role: p.role,
            faction: "AURA",
            type: "AURA",
            tag,                // admin / investigador / ""
            password,           // formato aur4_<aleat√≥rio>
            createdAt: serverTimestamp()
          };

          const docRef = doc(collection(db, "users"), p.code);
          await setDoc(docRef, payload);
          created++;
          lines += `${p.name} - ${password}\n`;
        }

        result.textContent = `‚úÖ ${created} perfis criados com sucesso!\n\n${lines}`;

        // download do ficheiro .txt
        const blob = new Blob([lines], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'senhas_aura.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

      } catch (err) {
        console.error(err);
        result.textContent = '‚ùå Erro: ' + (err.message || err);
      } finally {
        seedBtn.disabled = false;
      }
    }

    // Apagar cole√ß√£o users (√∫til para reset) ‚Äî aten√ß√£o: remove TODOS os documentos
    async function clearUsersCollection() {
      if (!confirm('Tens a certeza? Isto ir√° apagar todos os documentos dentro de users.')) return;
      clearBtn.disabled = true;
      result.textContent = 'üî¥ A apagar documentos na cole√ß√£o users...';
      try {
        const snap = await getDocs(collection(db, "users"));
        let count = 0;
        for (const d of snap.docs) {
          await deleteDoc(doc(db, "users", d.id));
          count++;
        }
        result.textContent = `‚úÖ Apagados ${count} documentos.`;
      } catch (err) {
        console.error(err);
        result.textContent = '‚ùå Erro ao apagar: ' + (err.message || err);
      } finally {
        clearBtn.disabled = false;
      }
      await logAction("apagou", "caso", title.value.trim());
    }

    seedBtn.addEventListener('click', seedUsers);
    clearBtn.addEventListener('click', clearUsersCollection);
  </script>
</body>
</html>
